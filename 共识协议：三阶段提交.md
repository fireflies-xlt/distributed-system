# 附
原文：[共识协议：三阶段提交](https://www.the-paper-trail.org/post/2008-11-29-consensus-protocols-three-phase-commit/)

# 正文
上一次，我们详细介绍了两阶段提交，这是一种共识算法，具有低延迟的优点，但由于参与者机器崩溃的脆弱性而被抵消。在这篇简短的文章中，我将解释如何向协议添加额外的阶段，以更大延迟为代价来增强协议（shore things up a bit）。

2PC的基本难点在于，一旦协调者做“提交”决定，并传达给一些副本，这些副本就会按照“提交”指令执行，而不检查其他副本是否得到该消息。然后，如果已经“提交”（committed）的副本与协调者一起崩溃，系统将无法知道事务的结果是什么(因为只有协调者和获得消息的副本知道确切的结果)。由于事务可能已经在崩溃的副本中提交，协议不能悲观地中止——因为事务可能产生无法撤消的副作用。类似地，协议不能乐观地强制事务提交，因为最初的投票可能是中止的。

这个问题主要通过在2PC中增加一个额外的阶段来避免的，毫无意外，这为我们提供三阶段提交协议。想法很简单，我们将2PC的“提交”阶段分为两个子阶段，第一个是“准备提交”阶段，当协调者在第一阶段收到一致的“yes”投票，它把消息发送给所有的副本。在收到此消息后，副本进入能够提交事务的状态，通过获取必要的锁等，但关键地，它不会做以后无法撤回的操作，接着回复协调者，告诉它“准备提交”的消息已经收到。

此阶段的目的是将投票的结果传递给每个副本，这样无论哪个副本宕机，协议的状态都可以恢复。

协议最后阶段做的事和2PC中的“提交或中止”阶段几乎相同。如果协调者在“准备提交”阶段收到所有副本的确认消息，就可以安全地执行提交事务。但是，如果没有收到确认，协调者不能保证协议在崩溃时能够恢复状态（如果你允许f个失败，协调者将在收到f+1个确认后继续执行）。在这种情况下，协调者将会中止事务。

如果协调者在任何时候崩溃，恢复节点可以接管事务，并从剩余副本查询状态，如果提交事务的副本崩溃了，我们知道其他副本已经收到“准备提交”的信息（否则协调者不会进入提交阶段），因此，恢复节点能够确定事务可以被提交，并安全引导协议完成。如果所有的副本向恢复节点报告它尚未收到“准备提交”，则恢复节点知道事务尚未在任何副本中提交，因此能悲观的中止，或从头开始一轮新的协议。

那么3pc能解决我们所有的问题吗?不完全是，但已经很接近了。在网络分区的情况下，会发生故障（the wheels rather come off） - 想象所有收到“准备提交”的副本在分区的一边，没有收到的副本在另一边。然后，两个分区将在（各自的）恢复节点下，分别继续提交或中止事务，当网络合并时，系统将具有不一致的状态。因此，和2PC一样，3PC可能在不安全的环境下运行，但总是能运行下去，因此满足其非阻塞（liveness ）属性。实际上，3PC不会在单节点故障时阻塞，这对于服务而言，高可用性比低延迟更加有吸引力。

下一次讨论共识时，我将尝试描述Paxos，它综合了2pc和3pc，最近在构建真实世界中的分布式复制状态机（如Chubby）中广受欢迎。
